##### TERRAFORM VM DEPLOYMENT TO HYPERVISORS
- name: Deploy Docker Virtual-Machines on Proxmox with Terraform
  hosts: localhost
  gather_facts: False
  roles:
    - terraform-prepare
    - terraform-apply
    - 5-minute-pause
  vars:
    vm_stack: docker-servers
    project_dir: /Terraform/proxmox/docker-servers/
    parallelism: 2

##### INITIAL CONFIGURATION
- name: Reboot machines, install updates and standard packages, configure SNMP and network shares
  hosts: docker_vms
  roles: 
    - base-packages
    - disable-motd-ubuntu
    - qemu-guest-agent-install
    - cockpit-install
    - snmp-configure
    - network-share-mount

##### PRE-SERVICE-CONFIGURATION SNAPSHOTS
- name: Take pre-service-configuration snapshot of VM-DOCKER-PROXY
  hosts: hypervisor-01
  roles:
    - proxmox-snapshot
  vars:
    vm_id: 100
    snapshot_name: Pre-service-configuration

- name: Take pre-service-configuration snapshot of VM-DOCKER-MEDIA
  hosts: hypervisor-01
  roles:
    - proxmox-snapshot
  vars:
    vm_id: 101
    snapshot_name: Pre-service-configuration

- name: Take pre-service-configuration snapshot of VM-DOCKER-SERVICES
  hosts: hypervisor-01
  roles:
    - proxmox-snapshot
  vars:
    vm_id: 102
    snapshot_name: Pre-service-configuration

- name: Take pre-service-configuration snapshot of VM-DOCKER-MANAGEMENT
  hosts: hypervisor-01
  roles:
    - proxmox-snapshot
  vars:
    vm_id: 103
    snapshot_name: Pre-service-configuration

##### SERVICE INSTALL
- name: Install GlusterFS and Docker
  hosts: docker_vms
  roles: 
    - glusterfs-service
    - docker-install

##### SERVICE-SPECIFIC CONFIGURATIONS
- name: Configure GlusterFS and start the service
  hosts: docker_management
  roles:
    - glusterfs-configure
  vars:
    nodes:
      - VM-DOCKER-MEDIA.hyvecloud.local
      - VM-DOCKER-SERVICES.hyvecloud.local
      - VM-DOCKER-PROXY.hyvecloud.local
    replicas: 4
    cluster:
      - VM-DOCKER-PROXY.hyvecloud.local
      - VM-DOCKER-MEDIA.hyvecloud.local
      - VM-DOCKER-SERVICES.hyvecloud.local
      - VM-DOCKER-MANAGEMENT.hyvecloud.local

- name: Mount glusterfs share to VMs
  hosts: docker_vms
  roles: 
    - glusterfs-mount

- name: Deploy Portainer to Proxy node
  hosts: docker_management
  roles: 
    - docker-portainer-deploy

- name: Deploy Portainer-agent to other Docker servers
  hosts: docker_media,docker_services,docker_proxy
  roles: 
    - docker-portainer-agent-deploy

##### REBOOT AND POST-CONFIGURATION SNAPSHOTS
- name: Reboot Virtual Machines
  hosts: docker_vms
  roles: 
    - reboot

- name: Take post-configuration snapshot of VM-DOCKER-PROXY
  hosts: hypervisor-01
  roles:
    - proxmox-snapshot
  vars:
    vm_id: 100
    snapshot_name: Post-configuration

- name: Take post-configuration snapshot of VM-DOCKER-MEDIA
  hosts: hypervisor-01
  roles:
    - proxmox-snapshot
  vars:
    vm_id: 101
    snapshot_name: Post-configuration

- name: Take post-configuration snapshot of VM-DOCKER-SERVICES
  hosts: hypervisor-01
  roles:
    - proxmox-snapshot
  vars:
    vm_id: 102
    snapshot_name: Post-configuration

- name: Take post-configuration snapshot of VM-DOCKER-MANAGEMENT
  hosts: hypervisor-01
  roles:
    - proxmox-snapshot
  vars:
    vm_id: 103
    snapshot_name: Post-configuration