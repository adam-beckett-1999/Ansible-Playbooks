- name: Install K3S on the master VM
  hosts: k3s_master
  become: true
  tasks:
    - name: Install K3S on the master VM
      shell: curl -sfL https://get.k3s.io | sh -
    - name: Get the token and register it
      ansible.builtin.slurp:
        src: "/var/lib/rancher/k3s/server/node-token"
      register: k3s_token
    - name: Print returned information
      ansible.builtin.debug:
        msg: "{{ k3s_token['content'] }}"
- name: Install K3S on the worker VMs
  hosts: k3s_nodes
  vars: k3s_token
  become: true
  tasks:
    - name: Install K3S on the workers
      shell: "curl -sfL https://get.k3s.io | K3S_URL=https://{{ hostvars[groups['k3s_master'][0]]['ansible_default_ipv4']['address'] }}:6443 K3S_TOKEN={{ node-token['content'] }} sh -"
- name: Check K3S service and get cluster status
  hosts: k3s_master
  become: true
  tasks:
    - name: Run kubectl status command to check that VMs joined correctly
      shell: kubectl get nodes
      register: k3s_cluster
    - name: Print returned information
      ansible.builtin.debug:
        msg: "{{ k3s_cluster }}"
    - name: Install the portainer agent on the master VM for management
      shell: kubectl apply -f https://downloads.portainer.io/ce2-18/portainer-agent-k8s-nodeport.yaml